pipeline {
    agent none

    tools {
        maven 'test-maven'
    }
    environment {
        Dev_name_Gloabal = "Sudipta Mukherjee"
    }
    // parameters {
    //     string defaultValue: 'SUDIPTA MUKHERJEE', name: 'FIRST_NAME'
    // }

//     parameters {
//     choice(
//         name: 'DEPLOY_ENV',
//         choices: ['none', 'linux-agent-1', 'linux-agent-2','prod'],
//         description: 'Select environment to deploy'
//     )
// }


    stages {
        stage('Build-maven-app-agent-2') {
             environment {
                    stage_specific_env = "Stage-Specific-Value_For Build-maven-app"
                }
            agent { label 'linux-agent-1' }
            steps {
                echo 'Building start...'
                sh 'mvn clean package -DskipTests'
                echo 'Building end...'
               
                //  echo "This is globally access value--->>>>${env.Dev_name_Gloabal}"
                // echo "${env.stage_specific_env}" 
                // echo "Parameter value is --->>>${params.FIRST_NAME}"


                // stash name: 'sudipta-app-jar', includes: 'target/my-app-1.0-SNAPSHOT.jar'
            }
           
        }

        stage('Test-maven-app') {
            agent { label 'linux-agent-1' }
            steps {
                echo 'Testing start...'
                sh 'mvn test'

                echo 'Testing end...'
            }

         post {
                success {
                    echo 'Archiving artifacts'
                    // archiveArtifacts artifacts: '**/target/*.jar', fingerprint: true
                    stash name: 'sudipta-app-jar', includes: 'target/my-app-1.0-SNAPSHOT.jar'
                }
            }
        }

        stage('Deploy to DEV') {
            when {
                branch 'staging-master'
            }

            agent { label 'linux-agent-2' }
            steps {
                echo 'Deploying to linux-agent-2 environment...'
                unstash 'sudipta-app-jar'
            sh '''
           java -jar target/my-app-1.0-SNAPSHOT.jar > deployed-dev.log
        '''
                echo 'Deployment to DEV completed.'
                echo "changes done on staging-master branch by ${env.Dev_name_Gloabal}"
            }

        }
         stage('Approve PROD') {
            when {
                branch 'master'
            }
            steps {
                input message: 'Deploy to PROD?', ok: 'Deploy'
            }
        }

        stage('Deploy PROD') {
            when {
                branch 'master'
            }
            agent { label 'prod' }
            steps {
                unstash 'sudipta-app-jar'
                sh '''
                  pkill -f my-app || true
                  nohup java -jar target/my-app-1.0-SNAPSHOT.jar \
                  --server.port=9091 > prod.log 2>&1 &
                '''
            }
        }

        stage('Verify PROD') {
             when {
                branch 'master'
            }
            agent { label 'prod' }
            steps {
                sh 'cat prod.log'
            }
        }


    }
}
